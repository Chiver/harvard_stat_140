# Week 01 学习指南 | STAT 140 实验设计

## 本周概览

欢迎来到 STAT 140！这周我们一起踏入因果推断（Causal Inference）的神奇世界。你知道吗？大多数人都会犯一个常见的错误——**相关性（Correlation）≠ 因果性（Causation）**。这门课就是来帮助我们设计严谨的实验，确立真正的因果关系。

这周特别重要，因为我们学到的**潜在结果框架（Potential Outcomes Framework）**和**分配机制（Assignment Mechanisms）**是整个实验设计课程的基石。掌握好这些概念，后面的所有内容都会变得清晰得多。

本周主要分为两个大模块：
1. **Module 1**：因果推断的基础概念，包括潜在结果、科学表、因果估计量和SUTVA假设
2. **Module 2**：分配机制，即如何科学地将单位分配到处理组和对照组

---

## Module 1: 因果推断的基础（Fundamentals of Causal Inference）

### 这节课讲了什么？

想象你是一个医学研究员，想知道某种新药是否真的能降低血压。你可能会给100个患者用药，然后看他们的血压是否下降了。但这里有个问题——我们怎么知道，如果不用药的话他们的血压会怎样呢？我们无法同时观察到一个人在用药和不用药两种情况下的结果。这就是**因果推断的根本悖论**。

这节课的核心就是教我们如何在这种"无法观察的世界"中思考因果关系。我们引入了一个强大的理论框架——**潜在结果框架**（由Rubin在上世纪70年代提出），它让我们可以用数学的方式定义"因果效应"。

### 核心概念

#### 1. 潜在结果框架（Potential Outcomes Framework）

**什么是潜在结果？** 对于每个单位（unit）i，我们想象两个平行宇宙：

- **$Y_i(1)$** = 单位 i 在接受处理（Treatment）时的潜在结果
- **$Y_i(0)$** = 单位 i 在不接受处理（Control）时的潜在结果

例如，对于一个患者Alice：
- $Y_{\text{Alice}}(1)$ = 她用药后的血压 = 110 mmHg
- $Y_{\text{Alice}}(0)$ = 她不用药时的血压 = 120 mmHg

**个体处理效应（Individual Treatment Effect）**定义为：

$$\tau_i = Y_i(1) - Y_i(0)$$

对Alice来说，$\tau_{\text{Alice}} = 110 - 120 = -10$，说明这种药能让她的血压降低10个单位。

**为什么叫"潜在"结果？** 因为对于任何真实的单位，我们在任何时间点只能观察到其中**一个**结果——要么她用了药（观察到$Y_i(1)$），要么她没用药（观察到$Y_i(0)$），不可能同时观察到两个。另一个结果永远是"反事实的（Counterfactual）"，存在于平行宇宙中。

**实例：教学方法研究**

假设我们研究新的教学方法是否能提高学生成绩。对于学生Bob：
- 如果他接受新教学方法，他的考试成绩是 92 分
- 如果他接受传统教学方法，他的考试成绩是 85 分
- 他的个体处理效应是：$\tau_{\text{Bob}} = 92 - 85 = 7$ 分

#### 2. 科学表（Science Table）

**科学表**是一个理想化的表格，显示了所有单位的两个潜在结果和他们的个体处理效应。这是一个"完美的信息"表——如果我们能看到这个表，因果推断就太简单了！

**例子：血压药物实验的科学表**

| 患者 | $Y_i(0)$（不用药） | $Y_i(1)$（用药） | $\tau_i$（处理效应） |
|------|-------------------|------------------|-------------------|
| Alice | 120 | 110 | -10 |
| Bob | 140 | 135 | -5 |
| Carol | 130 | 130 | 0 |
| Dave | 150 | 140 | -10 |
| Eve | 125 | 120 | -5 |
| Frank | 145 | 145 | 0 |

从这个科学表，我们可以立刻看到：
- 这种药对Alice和Dave最有效（降低10个单位）
- 对Carol和Frank无效（没有变化）
- 对Bob和Eve有中等效应

但在现实中，**我们永远看不到这个完整的表**。我们只能看到一个不完整的版本。

**现实中观察到的数据表：**

假设我们决定让Alice、Bob和Carol用药，其他人不用：

| 患者 | $W_i$（是否用药） | $Y_i^{\text{obs}}$（观察到的结果） |
|------|-----------------|-------------------------------|
| Alice | 1 | 110 |
| Bob | 1 | 135 |
| Carol | 1 | 130 |
| Dave | 0 | 150 |
| Eve | 0 | 125 |
| Frank | 0 | 145 |

现在我们缺少很多信息：
- 我们不知道Dave、Eve、Frank如果用药会怎样
- 我们不知道Alice、Bob、Carol如果不用药会怎样

#### 3. 因果估计量（Causal Estimands）：ATE、ATT、ATC

**平均处理效应（Average Treatment Effect, ATE）**

ATE是最常见的因果估计量，定义为平均个体处理效应：

$$\text{ATE} = \tau = \frac{1}{N}\sum_{i=1}^{N}\tau_i = \frac{1}{N}\sum_{i=1}^{N}[Y_i(1) - Y_i(0)] = \bar{Y}(1) - \bar{Y}(0)$$

换个角度讲，ATE就是如果我们能够让所有单位都接受处理，他们的平均结果，减去如果都不接受处理时的平均结果。

从我们的科学表例子：

$$\text{ATE} = \frac{1}{6}[(-10) + (-5) + 0 + (-10) + (-5) + 0] = \frac{-30}{6} = -5$$

这说明这种药平均能降低血压5个单位。

**获得处理的患者的平均处理效应（Average Treatment Effect on the Treated, ATT）**

有时候，我们关心的不是整体人口的平均效应，而是"获得了处理的人"这个特定子群体的平均效应：

$$\text{ATT} = \frac{1}{N_t}\sum_{i: W_i=1}[Y_i(1) - Y_i(0)]$$

其中$N_t$是接受处理的单位数量。

在我们的例子中，获得处理的患者是Alice、Bob和Carol：

$$\text{ATT} = \frac{1}{3}[(-10) + (-5) + 0] = -5$$

**对照组的平均处理效应（Average Treatment Effect on the Control, ATC）**

类似地，我们也可以计算如果对照组的人获得了处理，他们平均会获益多少：

$$\text{ATC} = \frac{1}{N_c}\sum_{i: W_i=0}[Y_i(1) - Y_i(0)]$$

在我们的例子中：

$$\text{ATC} = \frac{1}{3}[(-10) + (-5) + 0] = -5$$

有趣的是，在这个例子中ATT = ATC = ATE。但在现实中，这三个值通常是不同的，可能说明处理对不同人群有不同的效应。

**实例：在线学习平台的研究**

假设我们研究在线课程是否提高了学生的学习效果。我们的ATE可能是"+2个GPA点"，但我们发现：
- ATT（使用在线课程的学生）= +3个GPA点
- ATC（没有使用的学生）= +0.5个GPA点

这说明什么呢？如果我们强制那些原本不使用在线课程的学生去使用，效果会不如那些主动使用的学生。这提示我们处理效应可能是**异质的（Heterogeneous）**。

#### 4. 因果推断的根本问题（The Fundamental Problem of Causal Inference）

这是整个因果推断研究的核心难点，由Holland在1986年正式提出：

**对于任何单位i，在任何时间点，我们最多只能观察到$Y_i(1)$和$Y_i(0)$中的一个。**

换句话说，每个单位只能要么接受处理，要么不接受处理，不可能两者都做。这导致了一个直接的后果：

**我们永远无法直接观察个体处理效应$\tau_i$。**

这太遗憾了！但这也是为什么我们需要聪明的设计和统计方法。

那我们怎么办呢？关键策略是：

1. **通过实验设计获得可比较的群体** — 如果我们随机分配处理，那么接受处理的群体和不接受处理的群体在平均意义上是相同的

2. **估计ATE而不是$\tau_i$** — 虽然我们看不到个体效应，但我们可以通过比较两个群体的平均结果来估计平均效应

3. **有效的估计量** — 一个好的估计量应该是无偏的（Unbiased），即它的期望值等于真正的ATE

**数学解释：** 在一个完全随机化设计（我们待会讲）中，直观估计量

$$\hat{\text{ATE}} = \overline{Y}(1) - \overline{Y}(0)$$

其中$\overline{Y}(1)$是处理组的平均观察结果，$\overline{Y}(0)$是对照组的平均观察结果，这个估计量是ATE的无偏估计。

#### 5. SUTVA假设（Stable Unit Treatment Value Assumption）

SUTVA是因果推断中最重要的假设，包含两个部分：

**假设1：无干扰性（No Interference / No Spillover）**

一个单位的处理状态不影响其他单位的潜在结果。

数学表示：对于单位i和j（$i \neq j$），单位j的处理不影响单位i的潜在结果。

**假设2：无隐性处理变异（No Hidden Variations of Treatment）**

对所有接受同一处理的单位，处理的定义是相同的。没有"同一个处理的不同版本"。

**为什么这很重要？** 如果SUTVA被违反，我们的整个因果推断框架就会崩塌，因为潜在结果的定义会变得不清楚。

**SUTVA违反的例子：**

**例1：疫苗接种研究（违反无干扰性）**

假设我们研究疫苗是否能预防某种疾病。我们给某些人接种，不给另一些人接种，然后观察他们是否生病。

问题在于：**如果足够多的人接种了疫苗，那些没有接种的人也可能因为群体免疫而获得保护**。这意味着一个未接种者的潜在结果取决于有多少其他人接种了，这违反了无干扰假设。

| 场景 | 对照组比例 | 30% 免疫 | 60% 免疫 | 90% 免疫 |
|-----|----------|--------|--------|--------|
| 你的潜在结果$Y_i(0)$ | 0% | 生病概率 15% | 生病概率 5% | 生病概率 1% |

这样，单位i的潜在结果$Y_i(0)$不再是固定的，而是取决于环境！

**例2：网络社交实验（违反无干扰性）**

假设我们想研究一个新的社交媒体功能（"点赞按钮"）是否会增加用户参与度。我们给一些用户这个功能，不给另一些用户。

问题：如果用户A有了"点赞按钮"，他会给朋友B的帖子点更多赞，这会鼓励B发布更多内容——即使B没有获得"点赞按钮"这个处理！所以用户B的潜在结果取决于他的朋友是否获得了处理。

**例3：农业实验（违反无隐性处理变异）**

假设我们研究某种肥料是否能增加产量。但问题在于：
- 农民A用了这种肥料，但他很懒，只撒了一点点
- 农民B用了同一种肥料，但他很勤快，按照说明书撒了正确的量
- 农民C用了这种肥料，但他是肥料专家，调整了撒肥时间以最大化效果

这样，虽然他们都"获得了处理"，但实际上接受的是三种不同的处理！这违反了无隐性变异假设。

**应对SUTVA违反：**

1. **设计上的对策** — 选择合适的单位和处理，使得SUTVA更可能成立。比如，如果研究个人决策（而不是群体效应），干扰就较少可能
2. **敏感性分析** — 虽然假设不成立，我们也可以分析在多大程度的违反下，我们的结论仍然成立
3. **局部处理效应** — 对于被研究的特定人群和环境，定义处理效应，而不是试图定义普遍的处理效应

---

### 公式总结与例题

**关键公式速览：**

| 概念 | 公式 |
|-----|-----|
| 个体处理效应 | $\tau_i = Y_i(1) - Y_i(0)$ |
| 平均处理效应 | $\text{ATE} = \bar{Y}(1) - \bar{Y}(0)$ |
| 获得处理的患者的平均效应 | $\text{ATT} = E[Y_i(1) - Y_i(0) \mid W_i = 1]$ |
| 对照组的平均效应 | $\text{ATC} = E[Y_i(1) - Y_i(0) \mid W_i = 0]$ |
| 观察到的结果 | $Y_i^{\text{obs}} = W_i \cdot Y_i(1) + (1-W_i) \cdot Y_i(0)$ |

**例题1：从科学表计算ATE**

一个关于学习时间是否提高测试成绩的实验，科学表如下：

| 学生 | $Y_i(0)$（无学习） | $Y_i(1)$（学习） | $\tau_i$ |
|-----|-----------------|----------------|--------|
| 1 | 60 | 75 | 15 |
| 2 | 55 | 68 | 13 |
| 3 | 70 | 78 | 8 |
| 4 | 65 | 72 | 7 |

**求：** ATE

**解：**

$$\text{ATE} = \frac{1}{4}(15 + 13 + 8 + 7) = \frac{43}{4} = 10.75$$

或者用另一种方法：

$$\text{ATE} = \bar{Y}(1) - \bar{Y}(0) = \frac{75+68+78+72}{4} - \frac{60+55+70+65}{4} = 73.25 - 62.5 = 10.75$$

**例题2：识别SUTVA违反**

阅读以下三个实验描述，判断是否违反SUTVA：

a) 在一个小镇研究某种减肥药的效果，该药可能通过环境污染影响其他居民。
b) 在一个大公司研究培训项目是否提高员工生产力，该培训在不同分公司进行。
c) 在Facebook上研究界面改变（红色按钮 vs 蓝色按钮）是否增加点击，部分用户看到红色，部分看到蓝色，但他们会看到彼此的点击。

**答案：**
- a) **违反** — 药物污染可能通过空气或水影响其他人，存在干扰
- b) **可能不违反** — 不同分公司相对独立，干扰较小（假设员工不经常跨分公司合作）
- c) **违反** — 用户看到彼此的选择，这会影响彼此的行为和参与度

---

## Module 2: 分配机制（Assignment Mechanisms）

### 这节课讲了什么？

现在我们知道了什么是因果效应，下一个问题是：**我们如何公平地将单位分配到处理组和对照组？**

如果我们随意选择谁接受处理，比如让所有医学知识丰富的患者都选择新药，而让其他人用旧药，那我们永远无法知道是新药有效，还是那些聪明的患者本来就更善于照顾自己。这种由分配过程导致的问题叫做**混淆（Confounding）**。

这节课我们学习Fisher的三大原则，以及各种随机化分配机制，它们都试图通过随机选择谁接受处理来解决混淆问题。

### 核心概念

#### 1. Fisher的实验设计三原则（Fisher's Three Principles）

在20世纪20年代，Ronald Fisher为实验设计奠定了基础。他提出的三个原则至今仍是最佳实践：

**原则1：随机化（Randomization）**

通过随机分配处理来打破单位的自选偏差。

- **为什么重要？** 如果患者可以自己选择是否用药，那些病情更严重的患者可能更倾向于尝试新药。这样，即使新药毫无作用，我们观察到的用药组平均结果也可能更糟糕（因为他们一开始就病情更重）。

- **随机化的魔力** — 如果我们随机分配，那么在期望意义上，两组患者在处理前的特征（健康状况、年龄、性别等）应该是平衡的。

- **数学直觉** — 随机化破坏了潜在结果$Y_i(0), Y_i(1)$和处理指示器$W_i$之间的相关性。因此，我们可以通过比较观察到的结果来估计ATE，而不用担心混淆。

**原则2：区组/分层（Blocking / Local Control）**

将相似的单位分组，然后在每个组内部随机化。

- **为什么重要？** 某些特征可能对结果有很大影响。比如在医学实验中，患者的初始健康状况可能很重要。如果我们能够按照初始健康状况分组（"很差"、"中等"、"良好"），然后在每个组内部进行随机化，我们可以减少随机误差。

- **例子** — 在学习方法的实验中，不同年级学生的学习能力可能差异很大。我们可以按年级分层（一年级学生单独随机化，二年级学生单独随机化，等等），这样设计更精准。

- **数学好处** — 分层可以减少估计ATE的标准误（Standard Error），使我们的估计更精确。

**原则3：重复（Replication）**

有足够多的单位在每个处理组和对照组中。

- **为什么重要？** 如果我们只有两个患者——一个用药，一个不用药——那我们的实验基本没有说服力。我们需要足够的数据点来减少随机变异。

- **样本大小** — 更多的单位意味着我们的平均值估计会更稳定。这与中心极限定理有关：大样本的平均值接近正态分布，标准误为$\sigma/\sqrt{n}$。

- **统计功效** — 有足够的重复确保我们能够检测真实存在的效应。

#### 2. 分配机制（Assignment Mechanism）

**什么是分配机制？**

分配机制是一个概率法则，它规定了$\Pr(W | X, Y(0), Y(1))$，即给定单位的特征$X$和潜在结果$Y(0), Y(1)$，分配某个具体处理向量$W = (W_1, W_2, \ldots, W_N)$的概率。

这有点复杂，让我们用简单的话说：分配机制告诉我们，在已知所有单位的特征和（理想化的）潜在结果情况下，我们选择特定的谁-接受-处理-谁-不接受-处理安排的概率。

**例子：** 假设我们有4个患者。一个分配机制可能是"以50%的概率分配配置(treatment, treatment, control, control)，以50%的概率分配(treatment, control, treatment, control)"。

#### 3. 随机化分配机制的关键性质

一个好的随机化分配机制应该满足以下性质：

**性质1：个体主义（Individualistic）**

单位i的被分配概率只取决于单位i本身的特征，不取决于其他单位。

数学形式：$\Pr(W_i | X, Y(0), Y(1)) = \Pr(W_i | X_i, Y_i(0), Y_i(1))$

**性质2：概率性（Probabilistic）**

每个单位都有正的概率被分配到处理或对照：

$$0 < \Pr(W_i = 1) < 1$$

这很重要，因为如果某个单位总是被分配到对照（比如因为他的医生说"你太老了，不能尝试新药"），那我们就无法估计这类单位的处理效应。

**性质3：无混淆（Unconfoundedness）**

分配不依赖于潜在结果，只依赖于已观察的特征$X$：

$$\Pr(W | X, Y(0), Y(1)) = \Pr(W | X)$$

这意味着，给定已观察的特征，我们无法根据潜在结果来预测一个单位会被分配什么。换句话说，不存在"隐性混淆变量"。

**为什么无混淆这么重要？** 这是我们能够从观察数据中估计因果效应的关键前提。如果分配依赖于隐性的结果特征（比如医生知道某个患者会对新药有特别好的反应，所以优先分配新药给他），那我们就无法区分是新药有效，还是这个患者本来就特殊。

#### 4. 伯努利试验（Bernoulli Trial）

最简单的随机化方法：对每个单位独立地抛硬币，以概率$p$分配处理。

**定义：**
$$W_i \sim \text{Bernoulli}(p) \text{ independently for } i = 1, 2, \ldots, N$$

**处理分配的概率：**
$$\Pr(W) = p^{\sum_i W_i} \cdot (1-p)^{N - \sum_i W_i}$$

**优点：**
- 简单易实施
- 每个单位有相同的被分配概率$p$

**缺点：**
- 处理组的最终大小不确定！假设$p = 0.5, N = 100$，有可能35个人被分配到处理（而不是期望的50个），或者65个人被分配到处理。
- 这种随机波动可能影响我们估计的精确性。

**例子：** 一个关于在线广告的实验，我们以50%的概率向每个用户显示新广告或旧广告。100,000个用户中，可能49,500个看到新广告，50,500个看到旧广告。处理组大小在期望值周围波动。

#### 5. 完全随机化设计（Completely Randomized Design, CRD）

这是最常用的设计，它固定处理组和对照组的大小。

**定义：**

给定$N$个单位和$N_t$个应该被分配到处理的单位（$N_c = N - N_t$个对照），我们从所有可能的分配中**均匀随机**选择一个。

**可能分配的数量：**

$$\binom{N}{N_t} = \frac{N!}{N_t! \cdot N_c!}$$

例如，如果$N = 6, N_t = 3$，那么可能的分配数是：

$$\binom{6}{3} = \frac{6!}{3! \cdot 3!} = \frac{720}{6 \cdot 6} = 20$$

**每个分配的概率：**

$$\Pr(W) = \frac{1}{\binom{N}{N_t}}$$

所有20种可能的分配都有相等的概率$1/20$。

**每个单位被分配到处理的概率：**

$$\Pr(W_i = 1) = \frac{N_t}{N}$$

这很直观——如果总共有$N$个位置，其中$N_t$个在处理组，每个单位被分配到处理的概率自然就是$N_t/N$。

**例子：6人实验的完全随机化**

假设我们有6个患者（Alice, Bob, Carol, Dave, Eve, Frank），要随机分配3个到处理组，3个到对照组。

所有20种可能的分配：
1. (T, T, T, C, C, C)
2. (T, T, C, T, C, C)
3. (T, T, C, C, T, C)
4. ... （共20种）
20. (C, C, C, T, T, T)

我们通过某种随机过程（比如从帽子里随机抽卡片）选择其中一种，每种被选中的概率都是1/20。

每个患者被分配到处理的概率都是$3/6 = 0.5$。

**CRD vs 伯努利试验：对比**

| 特征 | 伯努利试验 | CRD |
|-----|---------|-----|
| 处理组大小 | 随机，期望值为$Np$ | 固定为$N_t$ |
| 实施简便性 | 非常简单 | 需要事先计划 |
| 精确性 | 可能波动较大 | 通常更精确 |
| 使用场景 | 在线实验（用户不断加入） | 固定规模的临床试验 |

#### 6. 分层/区组随机化（Stratified Randomized Design）

**动机：** 某些特征可能与结果高度相关。比如在医学实验中，患者的初始健康状况（糟糕/中等/良好）可能极大地影响最终结果。我们希望确保处理组和对照组在这个关键特征上是平衡的。

**实施方法：**

1. 将单位划分为$L$个分层（Strata）$S_1, S_2, \ldots, S_L$，基于某些已知的特征
2. 在每个分层内，独立地执行CRD或其他随机化
3. 最终的分配是所有分层内分配的并集

**例子：按年级分层的学习方法实验**

假设我们有60个学生，想研究新教学方法是否有效。我们知道不同年级的学生基线能力不同，所以我们分层：

- **分层1（一年级）**：20个学生，分配10个到处理，10个到对照
- **分层2（二年级）**：20个学生，分配10个到处理，10个到对照
- **分层3（三年级）**：20个学生，分配10个到处理，10个到对照

这样确保了处理组和对照组在各年级都平衡。

**好处：**
- 减少了估计标准误（因为我们控制了一个重要的混淆源）
- 在分层内的处理是平衡的

**坏处：**
- 实施更复杂
- 需要事先知道分层变量

#### 7. 配对实验（Paired Randomized Experiment）

配对实验是分层的极端情况，每个"分层"的大小为2。

**实施方法：**

1. 根据相似性将单位分成对（每对2个单位）
2. 在每对内，随机选择一个进入处理，另一个进入对照

**例子：减肥计划的配对设计**

首先，根据初始体重把30个参与者分成15对，每对内的人初始体重接近：
- 对1：体重85kg的张三，体重86kg的李四
- 对2：体重92kg的王五，体重93kg的赵六
- ...

然后，在每对内随机选择谁接受减肥计划。比如张三被选中接受计划，李四作为他的对照。

**好处：**
- 极大地减少估计误差（最强的平衡）
- 处理效应估计非常精确

**坏处：**
- 需要能够找到好的配对（有时很困难）
- 如果一对中的一个单位缺失，整对数据可能就浪费了

#### 8. 重随机化（Rerandomization）

这是一个更现代的想法：与其被动地接受随机化可能产生的不平衡，不如主动重新随机化直到达到足够的平衡。

**实施方法：**

1. 生成一个随机分配（比如使用CRD）
2. 检查这个分配是否在协变量上达到了"足够好"的平衡（使用某个平衡度量，比如马氏距离Mahalanobis Distance）
3. 如果平衡不够好，丢弃这个分配，回到第1步
4. 重复直到找到一个"足够平衡"的分配

**例子：临床试验的重随机化**

假设我们有100个患者，关键特征是年龄和初始血压水平。我们：
1. 生成一个CRD（50个处理，50个对照）
2. 计算处理组和对照组在年龄和血压上的平衡统计量
3. 如果不平衡（比如处理组的平均年龄是55岁，对照组是52岁），我们丢弃这个分配
4. 重新随机化，直到达到我们的平衡阈值（比如平均年龄差异<1岁）

**好处：**
- 比CRD更好地控制了已知的混淆
- 比配对设计更灵活

**坏处：**
- 需要计算能力
- 理论性质稍微复杂（虽然已被充分研究）

---

### 公式总结与例题

**关键概率公式：**

| 设计 | 关键公式 |
|-----|---------|
| 伯努利试验 | $\Pr(W_i = 1) = p$，$\Pr(W) = p^{\sum W_i}(1-p)^{N-\sum W_i}$ |
| CRD | $\Pr(W_i = 1) = N_t/N$，$\Pr(W) = 1/\binom{N}{N_t}$ |
| 分层CRD | 在每个分层$l$内，$\Pr(W_i = 1 \mid i \in S_l) = N_{t,l}/N_l$ |

**例题1：完全随机化设计的分配概率**

假设我们有10个患者，要将5个分配到处理，5个分配到对照。

a) 一个具体的分配（比如患者1-5接受处理，患者6-10接受对照）的概率是多少？

b) 患者3被分配到处理的概率是多少？

**解：**

a) 总的可能分配数：$\binom{10}{5} = 252$

每个具体分配的概率：$\Pr(W) = 1/252 \approx 0.00397$

b) 患者3被分配到处理的概率：$\Pr(W_3 = 1) = 5/10 = 0.5$

**例题2：分层随机化**

一个学习实验，40个学生分为两个年级：
- 一年级：20个学生
- 二年级：20个学生

我们在每个年级内执行CRD，一年级10个处理/10个对照，二年级也是10个处理/10个对照。

求：一年级的某个学生被分配到处理的概率

**解：**

这个学生只能在一年级的分配中，所以他被分配到处理的概率就是一年级处理组大小/一年级总数 = 10/20 = 0.5

**例题3：理解SUTVA和分配机制的关系**

解释为什么伯努利试验虽然形式上满足"无混淆"的要求，但在某些情况下仍可能导致问题。

**答案：**

伯努利试验确实是无混淆的：给定协变量$X$，分配概率$\Pr(W_i = 1 | X)$与潜在结果$Y_i(0), Y_i(1)$无关。

但是，伯努利试验可能导致**严重的不平衡**。想象：
- 100个患者中，我们以50%的概率分配处理
- 不幸地，80个患者被随机分配到处理，只有20个到对照
- 这样，即使没有混淆，我们的估计也会非常不精确（处理组大，对照组很小）

这说明，即使一个分配机制在理论上是"因果有效的"（无混淆），实践上的质量（平衡、精确性）仍然很重要。

---

## Section 1 要点回顾

这一部分通过practice problems巩固了我们在两个模块中学到的所有概念：

**关键点1：识别潜在结果和科学表**

你应该能够：
- 阅读一个实验描述，识别$Y_i(0)$和$Y_i(1)$的含义
- 从文本描述构造一个科学表
- 理解为什么我们永远看不到完整的科学表

**关键点2：计算因果估计量**

你应该能够：
- 从给定的科学表计算ATE、ATT、ATC
- 理解这些估计量之间的区别和联系
- 解释为什么异质处理效应（不同单位的$\tau_i$不同）会导致ATT≠ATC≠ATE

**关键点3：SUTVA的实际含义**

你应该能够：
- 识别一个实验描述中是否存在干扰或隐性处理变异
- 解释为什么特定的SUTVA违反会破坏因果推断
- 提出在SUTVA被违反时的对策

**关键点4：分配机制的数学和实践**

你应该能够：
- 计算CRD下某个特定分配的概率
- 计算CRD下单个单位被分配的概率
- 比较不同的分配机制（伯努利 vs CRD vs 分层 vs 配对）
- 理解分配机制如何通过随机化减少混淆

**典型Practice Problem：**

*一项包含20个农场的肥料实验。农场大小差异很大（从5英亩到500英亩）。我们想比较新肥料A和旧肥料B。*

*问题1：* 建议一个分配机制。为什么？

*答案：* 分层随机化，按农场大小分层。因为农场大小可能与产量高度相关，分层确保两组农场规模平衡。

*问题2：* 这个实验中可能存在SUTVA违反吗？

*答案：* 可能。如果一个农场用了新肥料A，溜出的肥料可能污染邻近农场，影响他们的产量。这是干扰。

*问题3：* 如果我们分配10个农场到肥料A，10个到肥料B，有多少种可能的分配？

*答案：* $\binom{20}{10} = 184,756$

---

## 概念关系图

```
                    ┌─────────────────────────┐
                    │  因果推断的根本问题     │
                    │ (Fundamental Problem)   │
                    └────────────┬────────────┘
                                 │
                    我们需要定义因果效应!
                                 │
                    ┌────────────▼────────────┐
                    │   潜在结果框架          │
                    │ (Potential Outcomes)    │
                    │  Y_i(0), Y_i(1), τ_i   │
                    └────────────┬────────────┘
                                 │
                 ┌────────────────┼────────────────┐
                 │                │                │
    ┌────────────▼──┐   ┌─────────▼────────┐   ┌──▼──────────────┐
    │   科学表      │   │  因果估计量      │   │  SUTVA假设      │
    │ (Science Tbl) │   │  ATE, ATT, ATC   │   │ (No interference)│
    └───────────────┘   └──────────────────┘   └─────────────────┘
                                 │
                                 │
                    我们如何从数据估计ATE?
                                 │
                    ┌────────────▼────────────┐
                    │   分配机制              │
                    │ (Assignment Mechanism)  │
                    └────────────┬────────────┘
                                 │
        ┌────────────┬───────────┼───────────┬────────────┐
        │            │           │           │            │
   ┌────▼───┐   ┌───▼───┐  ┌───▼───┐  ┌───▼────┐  ┌────▼────┐
   │伯努利  │   │CRD    │  │分层    │  │配对    │  │重随机化 │
   │试验    │   │完全   │  │随机化  │  │实验    │  │         │
   │        │   │随机化 │  │        │  │        │  │         │
   └────────┘   └───────┘  └───────┘  └────────┘  └─────────┘
        │            │           │           │            │
        └────────────┴───────────┼───────────┴────────────┘
                                 │
                    Fisher的三大原则:
                    1. 随机化
                    2. 区组/分层
                    3. 重复
                                 │
                    ┌────────────▼────────────┐
                    │   无混淆分配             │
                    │ (Unconfounded           │
                    │  Assignment)            │
                    └────────────┬────────────┘
                                 │
                    我们可以从观察数据估计ATE!
```

---

## 本周关键术语表

| 英文术语 | 中文术语 | 简要定义 |
|---------|---------|--------|
| Potential Outcome | 潜在结果 | 单位在特定处理下的假想结果 |
| Individual Treatment Effect | 个体处理效应 | $\tau_i = Y_i(1) - Y_i(0)$ |
| Average Treatment Effect | 平均处理效应 | 群体平均的处理效应，ATE |
| Causal Estimand | 因果估计量 | 我们想要从数据中估计的量（如ATE） |
| Science Table | 科学表 | 显示所有单位潜在结果的理想表格 |
| Fundamental Problem | 根本问题 | 我们无法同时观察到一个单位的两个潜在结果 |
| SUTVA | SUTVA假设 | 无干扰且无隐性处理变异的假设 |
| No Interference | 无干扰性 | 一个单位的处理不影响其他单位的结果 |
| Confounding | 混淆 | 由于分配偏差导致的难以区分真实因果效应的问题 |
| Assignment Mechanism | 分配机制 | 规定如何将单位分配到处理或对照的法则 |
| Randomization | 随机化 | 通过随机选择来破除混淆 |
| Completely Randomized Design (CRD) | 完全随机化设计 | 固定处理大小后均匀随机分配 |
| Stratified Design | 分层设计 | 先分组再在组内随机化 |
| Blocking | 区组化 | 同分层，根据相似特征分组 |
| Paired Experiment | 配对实验 | 特殊的分层设计，每层2个单位 |
| Bernoulli Trial | 伯努利试验 | 每个单位独立以概率$p$分配处理 |
| Unconfoundedness | 无混淆性 | 分配不依赖于潜在结果 |
| Replication | 重复 | 确保每组有足够的单位数量 |
| Treatment Effect Heterogeneity | 处理效应异质性 | 不同单位的处理效应不同 |
| Counterfactual | 反事实 | 没有实际发生但被假想的情景 |
| Observed Outcome | 观察结果 | 我们实际观察到的单个结果 |

---

## 学习建议与常见误区

### 如何学好本周内容？

1. **不要死记公式，要理解直觉**
   - 为什么ATE = $\bar{Y}(1) - \bar{Y}(0)$？因为我们想知道如果所有人都被处理，结果的改变。
   - 为什么我们需要随机化？因为随机化打破了潜在结果和处理分配之间的联系。

2. **用实际例子验证概念**
   - 想一个你关心的研究问题（比如某个减肥方案是否有效）
   - 自己构建潜在结果框架
   - 想象不同的分配机制会如何进行

3. **多做数值例子**
   - 手工计算小规模实验的ATE和概率
   - 这会加深你对公式的理解

4. **思考SUTVA违反的例子**
   - 这帮助你理解一个理论假设为什么重要
   - 现实中的数据往往部分违反SUTVA，但只要违反不太严重，因果推断仍然有效

### 常见误区

**误区1：** "随机化意味着完美平衡"
- **真实情况：** 随机化确保期望意义上的平衡，但在有限样本中，我们仍可能观察到不平衡。这就是为什么我们需要大样本和统计检验。

**误区2：** "ATE告诉我这种处理对我有没有用"
- **真实情况：** ATE是平均效应。对于个体效应，我们需要异质性分析。有时一个处理的ATE为0，但对你这个人很有用。

**误区3：** "完全随机化设计不如分层设计"
- **真实情况：** 不一定。当$N$足够大时，CRD就足够好。分层的优势在于减少方差，但代价是复杂性。选择哪个取决于你的具体情况。

**误区4：** "如果没有随机化，因果推断就不可能"
- **真实情况：** 这在某种意义上是对的（我们需要某种形式的因果识别假设），但即使没有完全的随机化，我们也可以通过其他方法（如倾向得分、工具变量等）进行因果推断。这是后续课程的内容。

---

## 后续预告

下周，我们将学习：

1. **统计推断** — 从样本估计ATE时的不确定性如何量化？
2. **线性模型** — 如何用回归方程表示因果效应？
3. **假设检验** — 如何检验处理是否有显著效应？

这些内容将帮助我们从理论走向实践：给定真实数据，我们如何有信心地做出因果结论？

---

## 复习清单

完成以下任务，确保你掌握了本周的内容：

- [ ] 能够对任何实验描述识别$Y_i(0), Y_i(1), W_i$的含义
- [ ] 能够从科学表计算ATE、ATT、ATC
- [ ] 能够解释SUTVA的两个部分以及为什么它们重要
- [ ] 能够列举至少3个SUTVA违反的真实例子
- [ ] 理解随机化如何打破混淆
- [ ] 能够计算不同分配机制下的概率（CRD、伯努利、分层等）
- [ ] 能够比较不同分配机制的优缺点
- [ ] 理解Fisher三大原则及其现代应用

**小建议：** 如果某项检查表项目还不确定，回头复习对应的部分，或在讨论论坛提问！这个话题虽然在开始时有些抽象，但一旦理解了核心直觉，后面的所有内容都会变得容易许多。

祝学习愉快！
